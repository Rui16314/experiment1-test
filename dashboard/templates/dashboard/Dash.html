
{% extends 'auction/Base.html' %}
{% block content %}
<h2>All Sessions Dashboard (5â€“8)</h2>
<p class="text-muted">This page aggregates the most recent session for each of the six experiment types.</p>

<h4 class="mt-4">5) Average bid vs valuation (six sessions, side-by-side)</h4>
<div class="row">
  {% for lbl in labels %}
  <div class="col-md-6">
    <div class="chart-box">
      <h6>{{ lbl }}</h6>
      <canvas id="s1_{{ forloop.counter }}"></canvas>
    </div>
  </div>
  {% endfor %}
</div>

<h4 class="mt-4">6) Average revenue by round (six sessions, side-by-side)</h4>
<div class="row">
  {% for lbl in labels %}
  <div class="col-md-6">
    <div class="chart-box">
      <h6>{{ lbl }}</h6>
      <canvas id="s3_{{ forloop.counter }}"></canvas>
    </div>
  </div>
  {% endfor %}
</div>

<h4 class="mt-4">7) Overall average revenue comparison</h4>
<canvas id="bar_overall"></canvas>

<h4 class="mt-4">8) Bonus summaries</h4>
<div class="row">
  <div class="col-md-6">
    <h6>Bid vs Valuation (pooled scatter)</h6>
    <canvas id="scatter"></canvas>
  </div>
  <div class="col-md-6">
    <h6>Share: over / under / equal bids</h6>
    <canvas id="pie"></canvas>
  </div>
</div>

<form method="post" class="mt-4">
  {% csrf_token %}
  <button class="btn btn-primary">Finish</button>
</form>

<script>
const series1 = {{ series1|safe }};
const series3 = {{ series3|safe }};
const bar = {{ bar_overall|safe }};
const pooled = {{ pooled_points|safe }};
const pie = {{ pie|safe }};

// Helper to draw a line chart
function drawLine(canvasId, label, data, xTitle, yTitle){
  new Chart(document.getElementById(canvasId), {
    type: 'line',
    data: { datasets: [{ label, data }] },
    options: { parsing: false, scales: { x: { title: {display:true, text:xTitle}}, y: { title: {display:true, text:yTitle}} } }
  });
}

// 5) average bid vs valuation
let i = 1;
Object.keys(series1).forEach(lbl => {
  drawLine('s1_' + (i++), lbl, series1[lbl], 'Valuation', 'Avg bid');
});

// 6) avg revenue by round
i = 1;
Object.keys(series3).forEach(lbl => {
  drawLine('s3_' + (i++), lbl, series3[lbl], 'Round', 'Avg revenue');
});

// 7) overall average revenue bar
new Chart(document.getElementById('bar_overall'), {
  type: 'bar',
  data: {
    labels: bar.map(x => x.label),
    datasets: [{ label: 'Overall avg revenue', data: bar.map(x => x.value) }]
  },
  options: { scales: { y: { title: {display:true, text:'Revenue'} } } }
});

// 8a) scatter
new Chart(document.getElementById('scatter'), {
  type: 'scatter',
  data: { datasets: [{ label: 'Bids vs Valuations', data: pooled }] },
  options: { scales: { x: { title: {display:true, text:'Valuation'} }, y: { title: {display:true, text:'Bid'} } } }
});

// 8b) pie
new Chart(document.getElementById('pie'), {
  type: 'pie',
  data: { labels: pie.map(p => p.label), datasets: [{ data: pie.map(p => p.value) }] },
});
</script>
{% endblock %}
