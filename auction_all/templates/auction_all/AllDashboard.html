{% extends 'auction_all/Base.html' %}
{% block content %}
<h2 style="max-width:var(--chart-max);margin:0 auto;">All Sessions Dashboard (5â€“8)</h2>
<p class="text-muted" style="max-width:var(--chart-max);margin:0 auto 8px;">Aggregated across all six sessions.</p>

<script type="application/json" id="series1_json">{{ series1|safe }}</script>
<script type="application/json" id="series3_json">{{ series3|safe }}</script>
<script type="application/json" id="bar_json">{{ bar_overall|safe }}</script>
<script type="application/json" id="pooled_json">{{ pooled_points|safe }}</script>
<script type="application/json" id="pie_json">{{ pie|safe }}</script>

<h4>5) Average bid vs valuation</h4>
<div id="rows_s1"></div>

<h4>6) Average revenue by round</h4>
<div id="rows_s3"></div>

<h4>7) Overall average revenue comparison</h4>
<div class="box"><div class="chart-wrap h-md"><canvas id="bar_overall"></canvas></div></div>

<h4>8) Bonus summaries</h4>
<div class="box"><div class="chart-wrap h-md"><canvas id="scatter"></canvas></div></div>
<div class="box"><div class="chart-wrap h-md"><canvas id="pie"></canvas></div></div>

<form method="post" class="mt-3"><button class="btn btn-primary">Finish</button></form>
{% endblock %}

{% block scripts %}
  {{ super }}
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    const opts={ responsive:true, maintainAspectRatio:false, plugins:{legend:{display:false}} };
    function J(id){ try{ return JSON.parse(document.getElementById(id).textContent || '{}'); }catch(e){ return {}; } }
    const s1=J('series1_json'), s3=J('series3_json'), bar=J('bar_json'), pooled=J('pooled_json'), pie=J('pie_json');

    function addPanel(containerId, title){
      const parent=document.getElementById(containerId);
      const box=document.createElement('div'); box.className='box';
      const h=document.createElement('h6'); h.textContent=title; box.appendChild(h);
      const wrap=document.createElement('div'); wrap.className='chart-wrap h-sm'; box.appendChild(wrap);
      const canvas=document.createElement('canvas'); wrap.appendChild(canvas);
      parent.appendChild(box); return canvas;
    }
    Object.keys(s1||{}).forEach(lbl=>{
      const c=addPanel('rows_s1', lbl);
      new Chart(c,{type:'line', data:{datasets:[{data:s1[lbl]||[], parsing:false, pointRadius:2, tension:0}]},
        options:{...opts, scales:{x:{type:'linear', title:{display:true,text:'Valuation'}}, y:{title:{display:true,text:'Avg bid'}}}}});
    });
    Object.keys(s3||{}).forEach(lbl=>{
      const c=addPanel('rows_s3', lbl);
      new Chart(c,{type:'line', data:{datasets:[{data:s3[lbl]||[], parsing:false, pointRadius:2, tension:0}]},
        options:{...opts, scales:{x:{type:'linear', title:{display:true,text:'Round'}}, y:{title:{display:true,text:'Revenue'}}}}});
    });

    if(Array.isArray(bar)&&bar.length){
      new Chart(document.getElementById('bar_overall'),{
        type:'bar', data:{labels:bar.map(x=>x.label), datasets:[{data:bar.map(x=>x.value)}]},
        options:{...opts, scales:{y:{title:{display:true,text:'Revenue'}}}}
      });
    }
    if(Array.isArray(pooled)&&pooled.length){
      new Chart(document.getElementById('scatter'),{type:'scatter', data:{datasets:[{data:pooled, parsing:false}]},
        options:{...opts, scales:{x:{type:'linear', title:{display:true,text:'Valuation'}}, y:{title:{display:true,text:'Bid'}}}}});
    }
    if(Array.isArray(pie)&&pie.length){
      new Chart(document.getElementById('pie'),{type:'pie', data:{labels:pie.map(p=>p.label), datasets:[{data:pie.map(p=>p.value)}]},
        options:{responsive:true, maintainAspectRatio:false}});
    }
  </script>
{% endblock %}