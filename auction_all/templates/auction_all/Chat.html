{% extends 'auction_all/Base.html' %}

{% block content %}
<h3>Chat with your opponent</h3>
<p>Your valuation this round: <strong>{{ my_value }}</strong></p>

<div id="chat" class="chatbox"></div>

<div style="max-width:520px;margin:8px 0;display:flex;gap:8px;">
  <input id="msg" type="text" class="form-control" placeholder="Type a message..." autocomplete="off" style="flex:1;">
  <button id="send" type="button" class="btn btn-secondary btn-sm">Send</button>
</div>

<form method="post">
  <button class="btn btn-primary">Go to bidding</button>
</form>
{% endblock %}

{% block scripts %}
{{ super }}
<style>
  .chatbox{ max-width:520px; height:180px; border:1px solid #e5e7eb; border-radius:8px; padding:8px; overflow-y:auto; background:#fff;}
  .chat-msg{ margin:4px 0; }
  .chat-msg.me{ font-weight:600; }
</style>
<script>
  const log = document.getElementById('chat');
  const inp = document.getElementById('msg');

  document.getElementById('send').addEventListener('click', () => {
    const t = (inp.value || '').trim();
    if(!t) return;
    liveSend({text: t});           // WebSocket; does NOT submit page
    inp.value=''; inp.focus();
  });
  inp.addEventListener('keydown', e => {
    if(e.key==='Enter'){ e.preventDefault(); document.getElementById('send').click(); }
  });

  function addLine(sender, text, me){
    const d = document.createElement('div');
    d.className = 'chat-msg' + (me ? ' me' : '');
    d.textContent = (me ? 'Me: ' : ('P'+sender+': ')) + text;
    log.appendChild(d);
    log.scrollTop = log.scrollHeight;
  }
  function liveRecv(payload){
    if(Array.isArray(payload)){ payload.forEach(p => addLine(p.sender, p.text, p.me)); }
    else if(payload && payload.text){ addLine(payload.sender, payload.text, payload.me); }
  }
</script>
{% endblock %}
