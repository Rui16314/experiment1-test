
{% extends 'auction_all/Base.html' %}
{% block content %}
<h3>Chat with your opponent</h3>
<p>Your valuation this round: <strong>{{ my_valuation }}</strong></p>

<div id="chat" class="chatbox"></div>

<div class="input-group mt-2">
  <input id="msg" class="form-control" placeholder="Type a message..." autofocus />
  <!-- IMPORTANT: explicit type=button so it doesn't submit the page form -->
  <button id="sendBtn" type="button" class="btn btn-secondary">Send</button>
</div>

<!-- This is the ONLY submit button on this page; it intentionally navigates -->
<form method="post" class="mt-3">
  <button class="btn btn-primary" name="next">Go to bidding</button>
</form>

<script>
const box = document.getElementById('chat');
const msg = document.getElementById('msg');
const sendBtn = document.getElementById('sendBtn');

function render(e){
  const p=document.createElement('div');
  p.textContent=(e.p==={{ player.id_in_group }}?'You: ':'Opponent: ')+e.text;
  box.appendChild(p);
  box.scrollTop=box.scrollHeight;
}

function doSend(){
  const t = msg.value.trim();
  if(!t) return;
  // liveSend does not navigate; it sends a websocket message to the server
  liveSend({text:t});
  msg.value='';
  msg.focus();
}

// Prevent any form submission when sending chat
sendBtn.addEventListener('click', function(ev){ ev.preventDefault(); doSend(); });
msg.addEventListener('keydown', function(ev){
  if(ev.key === 'Enter'){
    ev.preventDefault();
    doSend();
  }
});

function liveRecv(data){
  if(data.msg) render(data.msg);
}
</script>
{% endblock %}
