{% extends 'global/Page.html' %}

{% block content %}
<h3>Chat with your opponent</h3>
<p>Your valuation this round: <strong>{{ val_num }} POINTS</strong></p>

<div id="chat" class="chatbox"></div>

<div style="max-width:520px;margin:8px 0;display:flex;gap:8px;">
  <input id="msg" type="text" class="form-control" placeholder="Type a message..." autocomplete="off" style="flex:1;">
  <button id="send" type="button" class="btn btn-secondary btn-sm">Send</button>
</div>

<form method="post"><button class="btn btn-primary">Go to bidding</button></form>
{% endblock %}

{% block scripts %}
{{ super() }}
<style>
  .chatbox{ max-width:520px; height:180px; border:1px solid #e5e7eb; border-radius:8px; padding:8px; overflow-y:auto; background:#fff; }
  .chat-msg{ margin:4px 0; }
  .chat-msg.me{ font-weight:600; }
</style>
<script>
  const log = document.getElementById('chat');
  const inp = document.getElementById('msg');
  const btn = document.getElementById('send');

  function addLine(sender, text, me){
    const d = document.createElement('div');
    d.className = 'chat-msg' + (me ? ' me' : '');
    d.textContent = (me ? 'Me: ' : ('P' + sender + ': ')) + text;
    log.appendChild(d);
    log.scrollTop = log.scrollHeight;
  }

  // Make the receiver function global so oTree's websocket code can call it
  window.liveRecv = function(payload){
    console.log('liveRecv payload', payload);
    if (!payload) return;
    if (Array.isArray(payload)) {
      payload.forEach(p => addLine(p.sender, p.text, p.sender === jsVars.me));
    } else if (payload && payload.text) {
      addLine(payload.sender, payload.text, payload.sender === jsVars.me);
    }
  };

  // Send (do NOT add local line here; wait for server broadcast to avoid duplication)
  btn.addEventListener('click', () => {
    const t = (inp.value || '').trim();
    if (!t) return;

    console.log('Attempting to send:', t, 'liveSend type:', typeof liveSend, 'jsVars:', jsVars);
    if (typeof liveSend === 'function') {
      liveSend({ text: t });
    } else {
      // helpful visual error if liveSend is missing
      addLine('-', '⚠️ liveSend undefined — page is not LIVE. Check live_method and that you extend global/Page.html', false);
      console.warn('liveSend is undefined; page not LIVE or parent template missing.');
    }

    inp.value = '';
    inp.focus();
  });

  inp.addEventListener('keydown', e => {
    if (e.key === 'Enter') { e.preventDefault(); btn.click(); }
  });

  // debug helpers to run in console:
  // typeof liveSend
  // jsVars
  // check WS frames in Network -> WS
</script>
{% endblock %}

