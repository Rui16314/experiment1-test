{% extends 'global/Page.html' %}

{% block content %}
<h3>Chat with your opponent</h3>
<p>Your valuation this round: <strong>{{ val_num }} POINTS</strong></p>

<div id="chat" class="chatbox"></div>

<div style="max-width:520px;margin:8px 0;display:flex;gap:8px;">
  <input id="msg" type="text" class="form-control" placeholder="Type a message..." autocomplete="off" style="flex:1;">
  <button id="send" type="button" class="btn btn-secondary btn-sm">Send</button>
</div>

<form method="post"><button class="btn btn-primary">Go to bidding</button></form>
{% endblock %}

{% block scripts %}
{{ block.super }}
<style>
  .chatbox{ max-width:520px; height:180px; border:1px solid #e5e7eb; border-radius:8px; padding:8px; overflow-y:auto; background:#fff; }
  .chat-msg{ margin:4px 0; }
  .chat-msg.me{ font-weight:600; }
</style>
<script>
  const log=document.getElementById('chat'), inp=document.getElementById('msg'), btn=document.getElementById('send');

  function addLine(sender,text,me){
    const d=document.createElement('div');
    d.className='chat-msg'+(me?' me':'');
    d.textContent=(me?'Me: ':'P'+sender+': ')+text;
    log.appendChild(d); log.scrollTop=log.scrollHeight;
  }

  // oTree calls this when a message arrives from the server
  function liveRecv(payload){
    if (Array.isArray(payload)) payload.forEach(p=>addLine(p.sender,p.text,p.sender===jsVars.me));
    else if (payload && payload.text) addLine(payload.sender,payload.text,payload.sender===jsVars.me);
  }

  // Send and optimistically show my own line
  btn.addEventListener('click', ()=>{
    const t=(inp.value||'').trim();
    if(!t) return;
    addLine(jsVars.me, t, true);
    if (typeof liveSend==='function') liveSend({text:t});
    inp.value=''; inp.focus();
  });
  inp.addEventListener('keydown', e=>{ if(e.key==='Enter'){ e.preventDefault(); btn.click(); }});
</script>
{% endblock %}

