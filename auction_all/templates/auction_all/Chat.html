{% extends 'global/Page.html' %}

{% block content %}
<h3>Chat with your opponent</h3>
<p>Your valuation this round: <strong>{{ val_num }} POINTS</strong></p>

<div id="chat" class="chatbox"></div>

<div style="max-width:520px;margin:8px 0;display:flex;gap:8px;">
  <input id="msg" type="text" class="form-control" placeholder="Type a message..." autocomplete="off" style="flex:1;">
  <button id="send" type="button" class="btn btn-secondary btn-sm">Send</button>
</div>

<form method="post"><button class="btn btn-primary">Go to bidding</button></form>
{% endblock %}

{% block scripts %}
{{ super }}
<style>
  .chatbox{ max-width:520px; height:180px; border:1px solid #e5e7eb; border-radius:8px; padding:8px; overflow-y:auto; background:#fff; }
  .chat-msg{ margin:4px 0; }
  .chat-msg.me{ font-weight:600; }
</style>
<script>
  const MY_ID = {{ my_id }};             // provided by vars_for_template
  const log   = document.getElementById('chat');
  const inp   = document.getElementById('msg');
  const btn   = document.getElementById('send');

  if (typeof liveSend === 'undefined') {
    const warn=document.createElement('div');
    warn.style.color='#b91c1c'; warn.style.margin='8px 0';
    warn.textContent='⚠️ liveSend is undefined; this page is not LIVE (check live_method).';
    log.appendChild(warn);
  }

  function addLine(sender, text){
    const me = (sender === MY_ID);
    const d = document.createElement('div');
    d.className = 'chat-msg' + (me ? ' me' : '');
    d.textContent = (me ? 'Me: ' : ('P'+sender+': ')) + text;
    log.appendChild(d); log.scrollTop = log.scrollHeight;
  }

  // Receive messages from server (sent once to everyone)
  function liveRecv(payload){
    if (Array.isArray(payload)) { payload.forEach(p => addLine(p.sender, p.text)); }
    else if (payload && payload.text) { addLine(payload.sender, payload.text); }
  }

  btn.addEventListener('click', ()=>{
    const t = (inp.value || '').trim();
    if (!t || typeof liveSend === 'undefined') return;
    liveSend({text: t});         // does NOT submit the page
    inp.value = ''; inp.focus();
  });
  inp.addEventListener('keydown', e=>{
    if (e.key === 'Enter') { e.preventDefault(); btn.click(); }
  });
</script>
{% endblock %}
